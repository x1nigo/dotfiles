#! /bin/sh

# Functions
mountit() {
        sudo mount $name $mountpoint &&
                notify-send "ðŸ’¾ Drive successfully mounted." "$name is now mounted on $mountpoint."
}

decrypt() {
        ${TERMINAL:-st} -n "stFLOAT" -g 70x1 -e sudo cryptsetup open $name drive &&
                sudo mount /dev/mapper/drive $mountpoint &&
                notify-send "ðŸ”“ Successfully decrypted and mounted drive." "/dev/mapper/drive is now mounted on $mountpoint."
}

# We need to use this to separate the drives properly.
IFS=''

# Simple output of the lsblk command.
output=$(lsblk -rpo "name,size,fstype,type,mountpoint" | grep "part $")

# Get encrypted drives.
encrypted=$(echo $output | grep crypto_LUKS | awk '{print $1}')
# Get regular drives.
regular=$(echo $output | grep -v crypto_LUKS | awk '{print $1}')

# Jam everything into one variable for convenience.
alldrives=$(echo "$encrypted
$regular")
[ -z $alldrives ] && notify-send "ðŸ’¾ No drives found on this device." "Please try again." && exit 1
drive=$(echo $alldrives | dmenu -p 'Select drive to mount:')
[ -z $drive ] && exit 1
name=$(echo $drive | awk '{print $1}')
# Get filesystem type.
fstype=$(echo $output | grep $drive | awk '{print $3}')
# Mountpoints
mountpoint="$(find /mnt -maxdepth 2 -type d | dmenu -p 'Select a mountpoint:')"
[ -z $mountpoint ] && exit 1

[ "$fstype" = "crypto_LUKS" ] && decrypt || mountit
