#! /bin/sh

# NOTE: Make sure you have `ffmpeg` installed on your system.

file="$2"
base="${file%.*}"
ext="opus"

readme() { cat << EOF
mb: meta-blitz, configure metadata of audio/video files
for \`mpv\`, \`ncmpcpp\`, or any other media player.

Main actions:
  -s filename	Edit a single file's metadata manually
  -g		Edit metadata of items in a directory
  -A filename	Change artist
  -t filename	Change song/track title
  -a filename	Change album title
  -n filename	Change track number
  -y filename	Change publication year

NOTE: Make sure the file you input is a valid audio file.
EOF
}

errormsg() {
	printf "%s\n" "An error has occurred. Please try again. Make sure the file you're editing is a valid audio file."; exit 1
}

finalize() {
	mv -f procfile.$ext "$base.$ext" && \
		printf "Processing metadata complete!\n"
}

prompt() {
	printf "Is the above information correct? [y/N] "; read -r ans
	[ ! "$ans" = "y" ] && printf "The user has exited the script.\n" && exit 1
}

editmsg() {
	printf "%s\n" "Editing metadata of: \`$file\`"
}

unaedit() {
	editmsg
	printf "\t%s" "Title: "; read -r title
	printf "\t%s" "Artist: "; read -r artist
	printf "\t%s" "Album title: "; read -r album
	printf "\t%s" "Publication year: "; read -r year
	printf "\t%s" "Track number: "; read -r track
	prompt
	printf "Processing metadata...\n"
	ffmpeg -i "$file" -metadata artist="$artist" -metadata title="$title" -metadata album="$album" -metadata year="$year" -metadata track="$track" procfile.$ext >/dev/null 2>&1
}

editall() {
	printf "Album title: "; read -r album
	IFS='
	'
	for i in $(ls); do
		printf "%s\n" "Editing metadata of \`$i\`"
		printf "\t%s" "Title: "; read -r title
		printf "\t%s" "Artist: "; read -r artist
		printf "\t%s" "Publication year: "; read -r year
		printf "\t%s" "Track number: "; read -r track
		prompt
		printf "Processing metadata...\n"
		ffmpeg -i "$i" -metadata artist="$artist" -metadata title="$title" -metadata album="$album" -metadata year="$year" -metadata track="$track" procfile.$ext >/dev/null 2>&1 || errormsg
		mv -f procfile.$ext "$base.$ext"
	done
	printf "Processing metadata complete!\n"
}

changeartist() {
	editmsg
	printf "\tArtist: "; read -r artist
	prompt
	printf "Processing metadata...\n"
	ffmpeg -i "$file" -metadata artist="$artist" procfile.$ext >/dev/null 2>&1
}

changetitle() {
	editmsg
	printf "\tTitle: "; read -r title
	prompt
	printf "Processing metadata...\n"
	ffmpeg -i "$file" -metadata title="$title" procfile.$ext >/dev/null 2>&1
}

changealbum() {
	editmsg
	printf "\tAlbum title: "; read -r album
	prompt
	printf "Processing metadata...\n"
	ffmpeg -i "$file" -metadata album="$album" procfile.$ext >/dev/null 2>&1
}

changetrack() {
	editmsg
	printf "\tTrack number: "; read -r track
	prompt
	printf "Processing metadata...\n"
	ffmpeg -i "$file" -metadata track="$track" procfile.$ext >/dev/null 2>&1
}

changeyear() {
	editmsg
	printf "\tPublication year: "; read -r year
	prompt
	printf "Processing metadata...\n"
	ffmpeg -i "$file" -metadata year="$year" procfile.$ext >/dev/null 2>&1
}

while getopts "s:gA:t:a:n:y:h" o; do
	case ${o} in
		s) unaedit && finalize || errormsg ;;
		g) editall && exit 1 ;;
		A) changeartist && finalize || errormsg ;;
		t) changetitle && finalize || errormsg ;;
		a) changealbum && finalize || errormsg ;;
		n) changetrack && finalize || errormsg ;;
		y) changeyear && finalize || errormsg ;;
		*) readme && exit 1 ;;
	esac
done; readme
