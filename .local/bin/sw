#! /bin/sh

bglink="${XDG_DATA_HOME:-$HOME/.local/share}/bg"
bgdir="${XDG_DATA_HOME:-$HOME/.local/share}/backgrounds/"
file="$2"
cache=/tmp/bgtype

readme() { cat << EOF
sw: set-wallpaper, a minimal script meant to render
wallpapers

Main use:
 -a file.jpg	Add an image file to backgrounds folder
 -n file.jpg	Render a new wallpaper with file
 -s		Select a wallpaper from a list of items
 -r		Use random file with random mode
 -h		Display the readme message

Backgrounds directory:
 ~/.local/share/backgrounds
EOF
}

bgadd() {
	# Link input to the main `bg` file. If none, then exit script.
        [ -z $file ] && exit 1; cp $file $bgdir
}

bgsel() {
        bgsel="$(ls $bgdir | dmenu)"
        if [ -z "$bgsel" ]; then
                exit 0
        else
                mode="$(echo -e 'center\nmaximize\nstretch\ntile\nzoom' | dmenu)"
		[ -z "$mode" ] && exit 1
		echo $mode > "$cache"
		# Link chosen background to main `bg` file.
                ln -sf "$bgdir"/"$bgsel" $bglink
		# Notify on successful wallpaper
                xwallpaper --$mode "$bglink" && notify-send "üñºÔ∏è \`$bgsel\` set as wallpaper!" "\`$mode\` mode selected." && exit 0
        fi
}

bgnow() {
	ln -sf $(pwd)/"$file" $bglink
	mode="$(printf "center\nmaximize\nstretch\ntile\nzoom" | dmenu)"
	[ -z "$mode" ] && exit 1
	echo $mode > "$cache"
	xwallpaper --$mode "$bglink" && notify-send "üñºÔ∏è \`$file\` set as wallpaper!" "\`$mode\` mode selected." && exit 0
}

bgran() {
	bgsel=$(ls $bgdir | shuf | head -1)
	ln -sf "$bgdir"/"$bgsel" $bglink
	mode=$(printf "center\nmaximize\nstretch\ntile\nzoom" | shuf | tail -1)
	[ -z "$mode" ] && exit 1
	echo $mode > "$cache"
	xwallpaper --$mode "$bglink" && notify-send "üñºÔ∏è \`$bgsel\` set as wallpaper!" "\`$mode\` mode selected." && exit 0
}

while getopts "asnrh" o; do
	case ${o} in
		a) bgadd ;;
		s) bgsel ;;
		n) bgnow ;;
		r) bgran ;;
		h) readme ;;
		*) readme ;;
	esac
done

# Read the previously rendered mode.
[ -f "$cache" ] && read -r mode < "$cache"
# If no option was given, use the last known background.
xwallpaper --$mode "$bglink"
