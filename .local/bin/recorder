#!/bin/sh

# TODO:
# 	Record with audio
# 	Record without audio
# 	Record webcam
# 	Prompt to cancel current recording

audio() {
	ffmpeg -f x11grab \
	-video_size $(xrandr | grep eDP-1 | awk '{print $4}' | sed 's/+.*//g') \
	-framerate 25 \
	-i $DISPLAY \
	-c:v ffvhuff "$HOME/$(date +'screen-%y-%m-%d-%s').mkv"
}

noaudio() {
	ffmpeg -f x11grab \
	-video_size $(xrandr | grep eDP-1 | awk '{print $4}' | sed 's/+.*//g') \
	-framerate 25 \
	-i $DISPLAY \
	-f alsa \
	-i default \
	-c:v libx264 \
	-preset ultrafast \
	-c:a aac "$HOME/$(date +'screen-%y-%m-%d-%s').mp4"
}

webcam() {
	ffmpeg -f v4l2 \
	-video_size 640x480 \
	-i /dev/video0 \
	-c:v libx264 \
	-preset ultrafast "$HOME/$(date +'webcam-%y-%m-%d-%s').mp4"
}

stoprec() {
	killall ffmpeg && notify-send "üõë Recording process terminated."
}

notif() {
	notify-send "‚è∫Ô∏è Recording started!" "Capturing your device $1 now..."
}

while getopts "anws" o; do
	case ${o} in
		a) audio & notif screen ;;
		n) noaudio & notif screen ;;
		w) webcam & notif webcam ;;
		s) stoprec ;;
	esac
done

pgrep -a ffmpeg && \
	delprompt=$(printf "%s\n" "Yes" "No" | dmenu -p "Current recording detected. Delete its instance?" -l 5)

case $delprompt in
	Yes) stoprec ;;
esac

rectype=$(printf "%s\n" "screen with audio" "screen with no audio" "webcam only" | dmenu -p "What do you want to record?" -l 5)
case $rectype in
	"screen with audio") audio & notif screen ;;
	"screen with no audio") noaudio & notif screen ;;
	"webcam only") webcam & notif webcam ;;
esac
